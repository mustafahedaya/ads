const S_KEY = "v_sync_data";
const SALT = 7391;

const encodeData = (obj) => btoa(JSON.stringify(obj));
const decodeData = (str) => {
    try { return JSON.parse(atob(str)); } catch (e) { return null; }
};

function generateCheck(count, date) {
    const raw = `${count}|${date}|${SALT}`;
    let hash = 0;
    for (let i = 0; i < raw.length; i++) {
        hash = ((hash << 5) - hash) + raw.charCodeAt(i);
        hash |= 0;
    }
    return (hash >>> 0).toString(36);
}

document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const isVerified = urlParams.get('verified') === 'true';
    const extensionId = urlParams.get('extId'); // Dynamic ID from URL
    const isExternal = window.location.protocol === 'https:';

    const verifyView = document.getElementById('verify-view');
    const successView = document.getElementById('success-view');
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('status-text');
    const errorText = document.getElementById('error-text');
    const retryLink = document.getElementById('retry-link');

    // Helper to send message to extension (Internal or External)
    function sendMessage(msg, callback) {
        if (isExternal && extensionId) {
            chrome.runtime.sendMessage(extensionId, msg, callback);
        } else {
            chrome.runtime.sendMessage(msg, callback);
        }
    }

    // Validation Function - Safe for websites
    async function checkTabAlive() {
        if (isExternal) return true; // Can't check tabs from website, skip safety check

        try {
            const response = await new Promise(resolve => {
                chrome.runtime.sendMessage({ action: 'GET_LAST_AD_TAB' }, resolve);
            });
            const adTabId = response ? response.tabId : null;
            if (!adTabId) return false;
            const tab = await chrome.tabs.get(adTabId);
            return !!tab;
        } catch (e) { return false; }
    }

    // Path 1: Already verified (from GitHub direct link)
    if (isVerified) {
        grantReward();
        return;
    }

    // Path 2: Countdown Verification
    let timeLeft = 5;
    const totalTime = 5;

    const interval = setInterval(async () => {
        timeLeft -= 0.1;
        const progress = Math.min(100, ((totalTime - timeLeft) / totalTime) * 100);
        if (progressBar) progressBar.style.width = `${progress}%`;
        if (statusText) statusText.textContent = `Verifying... ${Math.ceil(timeLeft)}s`;

        if (timeLeft <= 0) {
            clearInterval(interval);
            grantReward();
        }
    }, 100);

    function grantReward() {
        if (isExternal) {
            // WE ARE ON GITHUB: Send message to extension
            sendMessage({ action: 'AD_COMPLETED' }, (response) => {
                if (chrome.runtime.lastError) {
                    failVerification("Connection failed. Please ensure the extension is active.");
                } else if (response && response.success) {
                    showSuccess();
                }
            });
        } else {
            // WE ARE INTERNAL: Update storage directly
            const today = new Date().toISOString().slice(0, 10);
            chrome.storage.local.get([S_KEY], (data) => {
                let encoded = data[S_KEY];
                let session = decodeData(encoded) || { c: 0, d: today, r: false, h: generateCheck(0, today) };
                session.r = true;
                session.h = generateCheck(session.c, session.d);
                chrome.storage.local.set({ [S_KEY]: encodeData(session) }, showSuccess);
            });
        }
    }

    function showSuccess() {
        if (verifyView) verifyView.style.display = 'none';
        if (successView) successView.style.display = 'block';
        setTimeout(() => {
            if (!isExternal) window.close();
            else if (statusText) statusText.textContent = "Verified! You can return to the extension.";
        }, 3000);
    }

    function failVerification(message) {
        if (statusText) statusText.style.display = 'none';
        if (errorText) {
            errorText.textContent = message;
            errorText.style.display = 'block';
        }
        if (retryLink) retryLink.style.display = 'inline';
    }
});
