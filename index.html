<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SyncPlay Protection</title>
    <!-- كود الإعلان الخاص بك ليتم فحصه أيضاً -->
    <script id="adScript" data-cfasync="false" src="//dcbbwymp1bhlf.cloudfront.net/?wbbcd=1232573"></script>
    
    <style>
        body { background: #0a0a0b; color: #fff; text-align: center; padding-top: 80px; font-family: 'Segoe UI', sans-serif; }
        .box { border: 2px solid #00e676; padding: 40px; border-radius: 20px; display:inline-block; max-width: 450px; background: rgba(0,230,118,0.05); transition: 0.5s; }
        .error-mode { border-color: #ff5252 !important; background: rgba(255,82,82,0.05) !important; }
        #unlockLink { 
            display: inline-block; padding: 18px 45px; font-size: 20px; background: #00e676; 
            text-decoration: none; border-radius: 50px; font-weight: bold; color: #000; 
            transition: 0.3s; pointer-events: none; opacity: 0.1;
        }
        .active-btn { pointer-events: auto !important; opacity: 1 !important; transform: scale(1.1); box-shadow: 0 0 20px #00e676; }
        #msg { margin-top: 20px; font-weight: bold; }
        .shaking { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
    </style>
</head>
<body>

    <!-- فخ (Trap) كبير لمانع الإعلانات -->
    <div class="ad-container ads-banner-top advertising_box pub_300x250" id="adTrap" 
         style="position:absolute; width:300px; height:250px; top:-1000px; left:-1000px; display:block !important; visibility:visible !important;">
        &nbsp;
    </div>

    <div class="box" id="mainBox">
        <h1 id="title">Security Check</h1>
        <p id="desc">Verifying your browser environment...</p>
        
        <div id="linkContainer">
            <a href="https://fibredelivery.com/aptk9jxjr?key=f4f39c9527ce233e6591af2452fadf16" 
               id="unlockLink" target="_blank" onclick="startCountdown()">UNLOCK NOW</a>
        </div>

        <p id="msg" style="color: #666;">Initializing script...</p>
    </div>

    <script>
        const unlockLink = document.getElementById('unlockLink');
        const mainBox = document.getElementById('mainBox');
        const msg = document.getElementById('msg');
        const adTrap = document.getElementById('adTrap');

        async function advancedDetection() {
            let isAdBlockActive = false;

            // 1. فحص العنصر (DOM Check)
            if (window.getComputedStyle(adTrap).display === 'none' || 
                window.getComputedStyle(adTrap).visibility === 'hidden' ||
                adTrap.offsetHeight === 0) {
                isAdBlockActive = true;
                console.log("AdBlock detected by DOM Trap");
            }

            // 2. فحص الشبكة (Network Check - محاولة تحميل رابط إعلانات جوجل)
            if (!isAdBlockActive) {
                try {
                    const response = await fetch('https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js', {
                        method: 'HEAD', mode: 'no-cors'
                    }).catch(() => { isAdBlockActive = true; });
                } catch (e) { isAdBlockActive = true; }
            }

            // 3. فحص كود الإعلان الخاص بك
            if (typeof P7Q === 'undefined') {
                // ملاحظة: قد لا يتوفر P7Q فوراً، لكن لو تم حظر السكريبت تماماً سيكون undefined
                console.log("Ad script variable P7Q missing");
            }

            if (isAdBlockActive) {
                fail();
            } else {
                success();
            }
        }

        function fail() {
            mainBox.classList.add('error-mode', 'shaking');
            msg.style.color = "#ff5252";
            msg.innerHTML = "⚠️ AdBlock Detected!<br>Access is blocked while AdBlock is active.";
            unlockLink.classList.remove('active-btn');
        }

        function success() {
            mainBox.classList.remove('error-mode');
            msg.style.color = "#00e676";
            msg.innerText = "✓ Browser Verified. You can proceed.";
            unlockLink.classList.add('active-btn');
        }

        function startCountdown() {
            unlockLink.style.display = 'none';
            msg.innerText = "Ad opened. Verifying support... (10s)";
            
            let time = 10;
            const timer = setInterval(() => {
                time--;
                msg.innerText = "Directing back in " + time + "s";
                if (time <= 0) {
                    clearInterval(timer);
                    const urlParams = new URLSearchParams(window.location.search);
                    let extId = urlParams.get('extId') || "eklimlgbcncdmdgqbjljbniaeljalcoj";
                    window.location.href = `chrome-extension://${extId}/success.html`;
                }
            }, 1000);
        }

        // تشغيل الفحص بعد التأكد من تحميل الصفحة
        window.onload = () => setTimeout(advancedDetection, 1200);
    </script>
</body>
</html>
