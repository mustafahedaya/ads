<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncPlay - Unlock Reward</title>
    
    <!-- Ad Script (Original) -->
    <script data-cfasync="false" src="//dcbbwymp1bhlf.cloudfront.net/?wbbcd=1232573"></script>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: #0a0a0a;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .card {
            background: #121212;
            padding: 3rem;
            border-radius: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            max-width: 420px;
            text-align: center;
            border: 1px solid #1f1f1f;
            position: relative;
        }
        .icon { font-size: 4rem; margin-bottom: 1.5rem; }
        h1 { font-size: 1.8rem; margin: 0 0 10px; background: linear-gradient(90deg, #00f2fe, #4facfe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p { color: #aaa; margin-bottom: 2.5rem; line-height: 1.6; }
        .btn {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            color: #000;
            border: none;
            padding: 18px 40px;
            border-radius: 15px;
            font-weight: 800;
            font-size: 1.1rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(79, 172, 254, 0.4); }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; box-shadow: none; }
        #status { margin-top: 25px; font-weight: 500; min-height: 24px; color: #4facfe; }
        .timer { font-family: monospace; font-size: 1.3rem; font-weight: bold; }
        .error { color: #ff5252; background: rgba(255,82,82,0.1); padding: 12px; border-radius: 10px; font-size: 0.9rem; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="card">
        <div class="icon" id="icon">⚡</div>
        <h1 id="title">Unlock Your Reward</h1>
        <p id="desc">Watch a short ad to unlock one extra room creation for today. Your progress is verified automatically.</p>

        <button id="ad-btn" class="btn">Watch Ad & Unlock</button>
        <div id="status">Ready to verify...</div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const extId = params.get('extId');
        const adBtn = document.getElementById('ad-btn');
        const status = document.getElementById('status');
        const adUrl = "https://fibredelivery.com/aptk9jxjr?key=f4f39c9527ce233e6591af2452fadf16";

        // 1. Initial Check: Is extension reachable?
        window.addEventListener('load', () => {
            if (!extId) {
                showError("Invalid link. Please open this from the SyncPlay extension.");
                adBtn.disabled = true;
                return;
            }
            
            // Ping extension to confirm connection
            chrome.runtime.sendMessage(extId, { action: 'PING' }, (resp) => {
                if (chrome.runtime.lastError) {
                    showError("Cannot connect to extension. Please ensure SyncPlay is installed and enabled.");
                    adBtn.disabled = true;
                }
            });
        });

        adBtn.addEventListener('click', () => {
            const win = window.open(adUrl, '_blank');
            if (!win) {
                showError("Popup blocked! Please allow popups for this site and try again.");
                return;
            }

            adBtn.disabled = true;
            let sec = 5;
            status.innerHTML = `Verifying ad view: <span class="timer">${sec}s</span>`;

            const timer = setInterval(() => {
                if (win.closed) {
                    clearInterval(timer);
                    showError("Ad window closed too early. Please watch the full ad.");
                    adBtn.disabled = false;
                    adBtn.textContent = "Try Again";
                    return;
                }

                sec--;
                if (sec > 0) {
                    status.innerHTML = `Verifying ad view: <span class="timer">${sec}s</span>`;
                } else {
                    clearInterval(timer);
                    grantReward();
                }
            }, 1000);
        });

        function grantReward() {
            status.textContent = "Unlocking reward...";
            
            chrome.runtime.sendMessage(extId, { action: 'AD_COMPLETED' }, (resp) => {
                if (chrome.runtime.lastError || !resp || !resp.success) {
                    showError("Verification failed. Please try again.");
                    adBtn.disabled = false;
                } else {
                    showSuccess();
                }
            });
        }

        function showSuccess() {
            document.getElementById('icon').textContent = "✅";
            document.getElementById('title').textContent = "Reward Granted!";
            document.getElementById('desc').textContent = "Your extra room is now available. You can close this window.";
            status.textContent = "";
            adBtn.style.display = "none";
            setTimeout(() => window.close(), 4000);
        }

        function showError(msg) {
            status.innerHTML = `<div class="error">${msg}</div>`;
        }
    </script>
</body>
</html>
